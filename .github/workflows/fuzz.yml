name: Continuous Fuzzing

on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Build matrix
        id: set-matrix
        run: |
          python - <<'PY'
          import json
          import glob
          import os

          files = sorted(os.path.basename(p) for p in glob.glob("fuzz/fuzz_*.py"))
          matrix = json.dumps({"fuzzer": files})
          with open(os.environ["GITHUB_OUTPUT"], "a") as output:
              output.write(f"matrix={matrix}\n")
          PY

  fuzz:
    needs: discover
    runs-on: ubuntu-latest
    timeout-minutes: 300
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements-fuzz.txt

      - name: Install fuzzing dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-fuzz.txt

      - name: Run fuzzer
        run: |
          python fuzz/${{ matrix.fuzzer }} -max_total_time=18000 -timeout=30

  report_failure:
    needs: fuzz
    if: ${{ always() && needs.fuzz.result == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      issues: write
    steps:
      - name: Create or update failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.runId;
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${runId}`;
            const title = "Fuzzing failure detected";

            const jobs = await github.paginate(
              github.rest.actions.listJobsForWorkflowRun,
              { owner, repo, run_id: runId, per_page: 100 }
            );
            const failedJobs = jobs
              .filter((job) => job.conclusion === "failure" || job.conclusion === "cancelled")
              .map((job) => job.name);
            const failedList = failedJobs.length
              ? failedJobs.map((name) => `- ${name}`).join("\n")
              : "- (unknown)";

            const body = [
              "Automated report: the scheduled fuzzing workflow failed.",
              "",
              `Run: ${runUrl}`,
              "",
              "Failed jobs:",
              failedList,
              "",
              "Please review the workflow logs and reproduce locally if needed."
            ].join("\n");

            const query = `repo:${owner}/${repo} is:issue is:open in:title "${title}"`;
            const search = await github.rest.search.issuesAndPullRequests({ q: query });
            if (search.data.total_count > 0) {
              const issueNumber = search.data.items[0].number;
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body,
              });
              core.info(`Updated existing issue #${issueNumber}`);
            } else {
              const issue = await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
              });
              core.info(`Created issue #${issue.data.number}`);
            }
